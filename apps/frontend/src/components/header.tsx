/* eslint-disable @next/next/no-img-element */
"use client";

import { provider, SERVER_URL } from "@/lib/ydoc";
import { useAuth } from "./auth-context";
import { useEffect, useState } from "react";
import { Button } from "./ui/button";
import { LogOutIcon } from "lucide-react";

type User = {
  name: string;
  color: `#${string}`;
  avatar?: string;
};

export const Header = () => {
  const { xUser, logout, user } = useAuth();
  const [users, setUsers] = useState<User[]>([]);

  useEffect(() => {
    const updateUsers = () => {
      const states = provider.awareness?.getStates().values() ?? [];

      const newUsers: User[] = [];
      for (const state of states) {
        if ("user" in state) {
          newUsers.push(state.user);
        }
      }

      setUsers(newUsers);
    };

    updateUsers();
    provider.awareness?.on("change", updateUsers);

    return () => {
      provider.awareness?.off("change", updateUsers);
    };
  }, []);

  const otherUsers = users.filter(
    (u) => u.name !== user.name && u.color !== user.color
  );

  return (
    <div className="fixed w-screen z-10 left-0 top-0 p-[24px] flex justify-between items-center">
      <div className="px-[16px] h-[54px] py-[8px] rounded-full flex items-center justify-center  backdrop-blur-[1px] bg-parchment/95 border border-black/10">
        <svg
          width="56"
          height="20"
          viewBox="0 0 28 10"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          className="mt-[8px]"
        >
          <path
            d="M1.548 7.02C1.18 7.02 0.887998 6.96 0.671998 6.84C0.455998 6.712 0.299998 6.552 0.203998 6.36C0.115998 6.168 0.0719981 5.972 0.0719981 5.772C0.0719981 5.484 0.167998 5.2 0.359998 4.92C0.551998 4.632 0.871998 4.352 1.32 4.08C1.776 3.8 2.384 3.532 3.144 3.276L3.468 3.168L3.492 2.196C3.5 1.9 3.408 1.656 3.216 1.464C3.024 1.264 2.772 1.164 2.46 1.164C2.164 1.164 1.924 1.252 1.74 1.428C1.564 1.596 1.436 1.848 1.356 2.184C1.332 2.272 1.236 2.352 1.068 2.424C0.899998 2.496 0.687998 2.532 0.431998 2.532C0.287998 2.532 0.179998 2.516 0.107998 2.484C0.0359981 2.444 0.0199981 2.364 0.0599981 2.244C0.187998 1.932 0.399998 1.648 0.695998 1.392C0.991998 1.136 1.328 0.931999 1.704 0.779999C2.08 0.619999 2.452 0.539999 2.82 0.539999C3.34 0.539999 3.764 0.663999 4.092 0.911999C4.428 1.16 4.588 1.508 4.572 1.956L4.452 5.532C4.444 5.844 4.52 6.044 4.68 6.132C4.848 6.22 5.164 6.28 5.628 6.312V6.672L5.208 6.78C4.944 6.844 4.74 6.892 4.596 6.924C4.452 6.964 4.34 6.984 4.26 6.984C4.044 6.984 3.88 6.936 3.768 6.84C3.664 6.744 3.588 6.632 3.54 6.504C3.5 6.376 3.472 6.272 3.456 6.192H3.36C3.016 6.528 2.696 6.752 2.4 6.864C2.112 6.968 1.828 7.02 1.548 7.02ZM2.16 6.144C2.448 6.144 2.684 6.1 2.868 6.012C3.06 5.916 3.232 5.816 3.384 5.712L3.456 3.696L3.336 3.732C2.752 3.908 2.312 4.104 2.016 4.32C1.72 4.536 1.52 4.748 1.416 4.956C1.312 5.156 1.26 5.328 1.26 5.472C1.26 5.92 1.56 6.144 2.16 6.144ZM7.79156 9.984C7.11156 9.984 6.56756 9.848 6.15956 9.576C5.75156 9.304 5.54756 8.952 5.54756 8.52C5.54756 8.352 5.59156 8.16 5.67956 7.944C5.77556 7.736 5.95956 7.496 6.23156 7.224L6.89156 6.564L7.44356 6.636C7.14756 6.972 6.92756 7.236 6.78356 7.428C6.63956 7.628 6.56756 7.848 6.56756 8.088C6.56756 8.448 6.71956 8.716 7.02356 8.892C7.33556 9.068 7.74756 9.156 8.25956 9.156C8.97956 9.156 9.53556 9.028 9.92756 8.772C10.3196 8.516 10.5156 8.18 10.5156 7.764C10.5156 7.492 10.4316 7.296 10.2636 7.176C10.0956 7.064 9.79956 6.992 9.37556 6.96L7.27556 6.804C6.81156 6.764 6.45156 6.668 6.19556 6.516C5.94756 6.356 5.82356 6.152 5.82356 5.904C5.82356 5.696 5.89556 5.524 6.03956 5.388C6.18356 5.252 6.36756 5.08 6.59156 4.872L6.96356 4.512H7.53956L7.17956 4.92C7.03556 5.08 6.94356 5.192 6.90356 5.256C6.86356 5.312 6.84356 5.368 6.84356 5.424C6.84356 5.528 6.89156 5.608 6.98756 5.664C7.09156 5.72 7.26356 5.756 7.50356 5.772L9.67556 5.952C10.6996 6.032 11.2116 6.492 11.2116 7.332C11.2116 7.828 11.0556 8.276 10.7436 8.676C10.4396 9.084 10.0276 9.404 9.50756 9.636C8.98756 9.868 8.41556 9.984 7.79156 9.984ZM8.05556 4.788C7.59156 4.788 7.18356 4.696 6.83156 4.512C6.47956 4.328 6.20356 4.076 6.00356 3.756C5.80356 3.436 5.70356 3.068 5.70356 2.652C5.70356 2.252 5.80356 1.896 6.00356 1.584C6.20356 1.264 6.47956 1.012 6.83156 0.827999C7.18356 0.635999 7.59156 0.539999 8.05556 0.539999L8.66756 0.743999C9.17156 0.831999 9.58756 1.044 9.91556 1.38C10.2436 1.708 10.4076 2.132 10.4076 2.652C10.4076 3.044 10.3076 3.404 10.1076 3.732C9.90756 4.052 9.63156 4.308 9.27956 4.5C8.92756 4.692 8.51956 4.788 8.05556 4.788ZM8.17556 4.2C8.55156 4.2 8.83956 4.084 9.03956 3.852C9.24756 3.612 9.35156 3.284 9.35156 2.868C9.35156 2.58 9.29556 2.304 9.18356 2.04C9.07956 1.768 8.92356 1.548 8.71556 1.38C8.50756 1.212 8.24756 1.128 7.93556 1.128C7.55956 1.128 7.26756 1.248 7.05956 1.488C6.85956 1.72 6.75956 2.048 6.75956 2.472C6.75956 2.744 6.81156 3.016 6.91556 3.288C7.01956 3.552 7.17556 3.772 7.38356 3.948C7.59956 4.116 7.86356 4.2 8.17556 4.2ZM8.05556 0.84V0.539999L10.9236 -9.53674e-07H11.2596V0.84H8.05556ZM14.024 7.02C13.376 7.02 12.808 6.884 12.32 6.612C11.832 6.34 11.452 5.96 11.18 5.472C10.908 4.984 10.772 4.42 10.772 3.78C10.772 3.132 10.908 2.564 11.18 2.076C11.452 1.588 11.828 1.212 12.308 0.947999C12.796 0.675999 13.364 0.539999 14.012 0.539999C14.66 0.539999 15.228 0.675999 15.716 0.947999C16.204 1.22 16.584 1.6 16.856 2.088C17.128 2.568 17.264 3.132 17.264 3.78C17.264 4.428 17.128 4.996 16.856 5.484C16.592 5.964 16.216 6.34 15.728 6.612C15.24 6.884 14.672 7.02 14.024 7.02ZM14.264 6.372C14.84 6.372 15.288 6.172 15.608 5.772C15.936 5.372 16.1 4.812 16.1 4.092C16.1 3.516 16 3.012 15.8 2.58C15.608 2.14 15.336 1.8 14.984 1.56C14.64 1.312 14.236 1.188 13.772 1.188C13.196 1.188 12.744 1.388 12.416 1.788C12.096 2.188 11.936 2.748 11.936 3.468C11.936 4.036 12.032 4.54 12.224 4.98C12.424 5.42 12.7 5.764 13.052 6.012C13.404 6.252 13.808 6.372 14.264 6.372ZM17.3206 6.9V6.42L17.5726 6.396C17.8446 6.372 18.0286 6.304 18.1246 6.192C18.2286 6.072 18.2806 5.876 18.2806 5.604V2.244C18.2806 1.988 18.2086 1.808 18.0646 1.704C17.9286 1.6 17.6886 1.544 17.3446 1.536V1.116L19.1566 0.587999H19.3246V1.548H19.4326C19.6006 1.3 19.8286 1.076 20.1166 0.875999C20.4046 0.668 20.7566 0.564 21.1726 0.564C21.4606 0.564 21.6766 0.62 21.8206 0.732C21.9726 0.844 22.0486 1.004 22.0486 1.212C22.0486 1.356 21.9926 1.484 21.8806 1.596C21.7766 1.7 21.6526 1.772 21.5086 1.812C21.3646 1.844 21.2286 1.824 21.1006 1.752L20.6326 1.488C20.5126 1.416 20.3846 1.404 20.2486 1.452C20.1206 1.492 19.9966 1.568 19.8766 1.68C19.7646 1.784 19.6606 1.896 19.5646 2.016C19.4766 2.136 19.4086 2.24 19.3606 2.328V5.604C19.3606 5.876 19.4246 6.068 19.5526 6.18C19.6806 6.284 19.9326 6.356 20.3086 6.396L20.5606 6.42V6.9H17.3206ZM23.2811 7.02C22.9131 7.02 22.6211 6.96 22.4051 6.84C22.1891 6.712 22.0331 6.552 21.9371 6.36C21.8491 6.168 21.8051 5.972 21.8051 5.772C21.8051 5.484 21.9011 5.2 22.0931 4.92C22.2851 4.632 22.6051 4.352 23.0531 4.08C23.5091 3.8 24.1171 3.532 24.8771 3.276L25.2011 3.168L25.2251 2.196C25.2331 1.9 25.1411 1.656 24.9491 1.464C24.7571 1.264 24.5051 1.164 24.1931 1.164C23.8971 1.164 23.6571 1.252 23.4731 1.428C23.2971 1.596 23.1691 1.848 23.0891 2.184C23.0651 2.272 22.9691 2.352 22.8011 2.424C22.6331 2.496 22.4211 2.532 22.1651 2.532C22.0211 2.532 21.9131 2.516 21.8411 2.484C21.7691 2.444 21.7531 2.364 21.7931 2.244C21.9211 1.932 22.1331 1.648 22.4291 1.392C22.7251 1.136 23.0611 0.931999 23.4371 0.779999C23.8131 0.619999 24.1851 0.539999 24.5531 0.539999C25.0731 0.539999 25.4971 0.663999 25.8251 0.911999C26.1611 1.16 26.3211 1.508 26.3051 1.956L26.1851 5.532C26.1771 5.844 26.2531 6.044 26.4131 6.132C26.5811 6.22 26.8971 6.28 27.3611 6.312V6.672L26.9411 6.78C26.6771 6.844 26.4731 6.892 26.3291 6.924C26.1851 6.964 26.0731 6.984 25.9931 6.984C25.7771 6.984 25.6131 6.936 25.5011 6.84C25.3971 6.744 25.3211 6.632 25.2731 6.504C25.2331 6.376 25.2051 6.272 25.1891 6.192H25.0931C24.7491 6.528 24.4291 6.752 24.1331 6.864C23.8451 6.968 23.5611 7.02 23.2811 7.02ZM23.8931 6.144C24.1811 6.144 24.4171 6.1 24.6011 6.012C24.7931 5.916 24.9651 5.816 25.1171 5.712L25.1891 3.696L25.0691 3.732C24.4851 3.908 24.0451 4.104 23.7491 4.32C23.4531 4.536 23.2531 4.748 23.1491 4.956C23.0451 5.156 22.9931 5.328 22.9931 5.472C22.9931 5.92 23.2931 6.144 23.8931 6.144Z"
            fill="#282415"
          />
        </svg>
      </div>

      <div className="bg-parchment/95 backdrop-blur-[1px] flex flex-row items-center justify-center rounded-full border border-black/10">
        {otherUsers.length ? (
          <div className="p-[16px] py-[12px] border-r border-black/10">
            <div className="flex -space-x-[10px]">
              {otherUsers.map((u, i) => (
                <div key={i} className="relative group">
                  {u.avatar ? (
                    <img
                      src={u.avatar}
                      alt={u.name}
                      className="w-[28px] h-[28px] rounded-full"
                      style={{
                        borderWidth: 2,
                        borderStyle: "solid",
                        borderColor: u.color,
                      }}
                    />
                  ) : (
                    <div
                      className="w-[28px] h-[28px] rounded-full border border-black/10"
                      style={{ backgroundColor: u.color }}
                    />
                  )}
                  <span className="absolute top-full mt-1 left-1/2 -translate-x-1/2 text-xs bg-parchment/95 backdrop-blur-[1px] rounded-full text-text-primary px-[8px] py-[4px] whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none border border-black/10">
                    {u.name}
                  </span>
                </div>
              ))}
            </div>
          </div>
        ) : null}
        <div className="p-[16px] py-[12px] flex flex-row gap-[8px]">
          <div className="relative group">
            {xUser?.avatar ? (
              <img
                src={xUser.avatar}
                alt={user.name}
                className="w-[28px] h-[28px] rounded-full"
                style={{
                  borderWidth: 2,
                  borderStyle: "solid",
                  borderColor: user.color,
                }}
              />
            ) : (
              <div
                className="w-[28px] h-[28px] rounded-full border border-black/10"
                style={{ backgroundColor: user.color }}
              />
            )}
            <span className="absolute top-full mt-1 left-1/2 -translate-x-1/2 text-xs bg-parchment/95 backdrop-blur-[1px] rounded-full text-text-primary px-[8px] py-[4px] whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none border border-black/10">
              {xUser?.handle ? `@${xUser.handle}` : user.name}
            </span>
          </div>
          {xUser ? (
            <Button
              onClick={logout}
              variant="ghost"
              size="icon"
              className="size-[28px]"
            >
              <LogOutIcon className="size-[16px]" />
            </Button>
          ) : (
            <Button variant="ghost" size="icon" className="size-[28px]" asChild>
              <a href={`${SERVER_URL}/api/auth/x`}>
                <svg
                  role="img"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  id="X--Streamline-Simple-Icons"
                  height="16"
                  width="16"
                >
                  <path
                    d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8 -7.584 -6.638 7.584H0.474l8.6 -9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"
                    fill="#000000"
                    strokeWidth="1"
                  ></path>
                </svg>
              </a>
            </Button>
          )}
        </div>
      </div>
    </div>
  );
};
